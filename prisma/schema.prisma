generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum Language {
  tr
  en
  nl
}

model Article {
  id          String        @id @default(cuid())
  slug        String        @unique
  category    String
  tags        String[]
  imageUrl    String?
  published   Boolean       @default(false)
  publishedAt DateTime?
  mode        String        @default("mode_b")
  qaScore     Float?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  translations Translation[]
  source        Source?

  @@index([category])
  @@index([published, publishedAt])
}

model Translation {
  id              String          @id @default(cuid())
  lang            Language
  slug            String          // SEO-friendly URL slug for this language
  title           String
  summary         String
  body            String
  author          String
  seoTitle        String
  metaDescription String
  canonicalUrl    String?
  publishedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  article   Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId String

  approval ApprovalQueue?

  @@unique([articleId, lang])
  @@unique([lang, slug])  // Each language has unique slugs
  @@index([slug])         // Fast lookup by slug
}

model Source {
  id                String   @id @default(cuid())
  articleId         String   @unique
  originalSource    String
  sourceUrl         String
  fetchedAt         DateTime @default(now())
  sourceFingerprint String   @unique
  language          String
  wordCount         Int

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
}

model ApprovalQueue {
  id               String          @id @default(cuid())
  status           ApprovalStatus  @default(pending)
  reviewerId       String?
  notes            String?
  scoreReadability Float?
  scoreSimilarity  Float?
  toxicityFlag     Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  translationId String   @unique
  translation   Translation @relation(fields: [translationId], references: [id], onDelete: Cascade)
}

model MetricLog {
  id        String   @id @default(cuid())
  key       String
  value     Float
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([key, createdAt])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  translations CategoryTranslation[]
}

model CategoryTranslation {
  id         String   @id @default(cuid())
  lang       Language
  name       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String

  @@unique([categoryId, lang])
}

// ==========================================
// Site Settings & Configuration Models
// ==========================================

enum SettingGroup {
  general
  seo
  appearance
  advanced
  social
}

model SiteSetting {
  id        String       @id @default(cuid())
  key       String       @unique
  value     String       @db.Text
  type      String       @default("string") // string, boolean, number, json
  group     SettingGroup @default(general)
  label     String?      // Human-readable label
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([group])
}

model SmtpSetting {
  id        String   @id @default(cuid())
  host      String
  port      Int      @default(587)
  secure    Boolean  @default(false)
  username  String
  password  String   // Encrypted
  fromEmail String
  fromName  String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// Advertisement Models
// ==========================================

enum AdProvider {
  custom
  google_adsense
  google_admanager
}

enum AdPlacement {
  header
  sidebar_top
  sidebar_bottom
  footer
  in_article
  between_posts
  popup
  sticky_bottom
}

model AdSlot {
  id          String      @id @default(cuid())
  name        String
  placement   AdPlacement
  description String?
  width       Int?
  height      Int?
  isActive    Boolean     @default(true)
  priority    Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  advertisements Advertisement[]

  @@unique([placement])
}

model Advertisement {
  id          String     @id @default(cuid())
  name        String
  slotId      String
  slot        AdSlot     @relation(fields: [slotId], references: [id], onDelete: Cascade)
  provider    AdProvider @default(custom)

  // For custom ads
  imageUrl    String?
  linkUrl     String?
  altText     String?

  // For Google Adsense/AdManager
  adCode      String?    @db.Text
  adUnitId    String?

  // Targeting
  startDate   DateTime?
  endDate     DateTime?
  targetLangs String[]   // ["tr", "en", "nl"] or empty for all

  // Analytics
  impressions Int        @default(0)
  clicks      Int        @default(0)

  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slotId, isActive])
}

// ==========================================
// RSS Feed & Bot Automation Models
// ==========================================

enum FeedPriority {
  high      // Check every 5 minutes
  medium    // Check every 15 minutes
  low       // Check every 30 minutes
}

enum FeedStatus {
  active
  paused
  error
}

model RssFeed {
  id            String       @id @default(cuid())
  name          String       // e.g., "The Verge"
  url           String       @unique
  category      String       // Maps to article category
  priority      FeedPriority @default(medium)
  status        FeedStatus   @default(active)
  
  // Incremental fetching
  lastFetchedAt DateTime?
  lastItemGuid  String?      // Last processed item GUID/link
  lastItemDate  DateTime?    // Last processed item pubDate
  
  // Stats
  totalFetched  Int          @default(0)
  totalPublished Int         @default(0)
  errorCount    Int          @default(0)
  lastError     String?
  
  // Settings
  maxItemsPerFetch Int       @default(10)
  language      String       @default("en") // Source language
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  fetchedItems  FetchedItem[]

  @@index([status, priority])
}

model FetchedItem {
  id            String   @id @default(cuid())
  feedId        String
  feed          RssFeed  @relation(fields: [feedId], references: [id], onDelete: Cascade)
  
  guid          String   // RSS item guid or link
  title         String
  link          String
  pubDate       DateTime?
  contentHash   String   // For cross-source deduplication
  simHash       String   // SimHash for similarity detection
  
  // Content storage for AI processing
  body          String?  @db.Text  // Full article body
  summary       String?  @db.Text  // Article summary
  
  // Processing status
  processed     Boolean  @default(false)
  articleId     String?  // If processed, link to article
  skippedReason String?  // "duplicate", "low_quality", etc.
  
  createdAt     DateTime @default(now())

  @@unique([feedId, guid])
  @@index([contentHash])
  @@index([simHash])
  @@index([processed, createdAt])
}

model BotSettings {
  id                    String   @id @default(cuid())
  
  // Scheduler settings
  isEnabled             Boolean  @default(true)
  highPriorityInterval  Int      @default(5)  // minutes
  mediumPriorityInterval Int     @default(15) // minutes
  lowPriorityInterval   Int      @default(30) // minutes
  
  // Daily limits
  dailyArticleTarget    Int      @default(50)
  maxArticlesPerHour    Int      @default(10)
  
  // Quality settings
  minQaScore            Float    @default(0.85)
  autoPublish           Boolean  @default(true)
  
  // Deduplication
  simHashThreshold      Int      @default(3)  // Hamming distance
  crossSourceDedup      Boolean  @default(true)
  
  // Paywall/Clickbait filtering
  enablePaywallFilter   Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model BotRunLog {
  id            String   @id @default(cuid())
  priority      FeedPriority
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  
  // Stats
  feedsChecked  Int      @default(0)
  itemsFetched  Int      @default(0)
  itemsProcessed Int     @default(0)
  itemsPublished Int     @default(0)
  itemsSkipped  Int      @default(0)
  
  errors        String[] @default([])
  
  @@index([startedAt])
}
